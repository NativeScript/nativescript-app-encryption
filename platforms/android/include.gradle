android {
    productFlavors {
        "protect" {
            dimension "protect"
        }
    }
}

def isWinOs = System.properties['os.name'].toLowerCase().contains('windows') ;  
def encryptionKey;

task appProtectionInclude (dependsOn: "collectAllJars")  << {

    println "App protection include started"  
       
    FileTree tree = fileTree(dir: "$rootDir/src/main/assets/app", include: ["**/*.js"], exclude:  ["**/app.js", "tns_modules/**"])
    tree.each { File file ->
        
        println "Encrypting file: " + file
        
        exec {
            commandLine "node", "../../node_modules/nativescript-app-protection/scripts/encrypt-file.js", encryptionKey , file.getAbsolutePath(),  file.getAbsolutePath()
        }
    } 
}

task generateEncryptionKey << {
    
    def stdout = new ByteArrayOutputStream()
    exec {
        commandLine "node", "../../node_modules/nativescript-app-protection/scripts/generate-aes256-key.js"
        standardOutput = stdout
    }
        
    println "Encryption key: " + stdout.toString();
    encryptionKey = stdout.toString();
}

task saveEncryptionKey << {
	
    String javaFileName = "$rootDir/src/main/java/com/tns/RuntimeHelper.java";
    String contents = new File(javaFileName).getText("UTF-8");
    
    String protectionKeySetter = "com.tns.app_protection.AppProtection.setKey";
    String addThis = protectionKeySetter + "(\"" + encryptionKey + "\");";

    if (contents.contains(protectionKeySetter))
    {
       println "replacing protection key";
       contents = contents.replaceFirst(protectionKeySetter + ".*", addThis);
    }
    else
    {
        println "setting new protection key";
        contents = contents.replaceFirst(/System.loadLibrary\("NativeScript"\);/, "System.loadLibrary(\"NativeScript\");\n" + addThis);
         
        println contents;
    }
    
    println "Writting java file: " + javaFileName;
	new File(javaFileName).write(contents, "UTF-8");
}

// apply the plugin only for release builds
appProtectionInclude.onlyIf { project.hasProperty('release') }

saveEncryptionKey.dependsOn generateEncryptionKey
appProtectionInclude.dependsOn generateEncryptionKey

appProtectionInclude.mustRunAfter "collectAllJars"

appProtectionInclude.finalizedBy saveEncryptionKey

pluginExtend.finalizedBy appProtectionInclude 


allprojects {
    afterEvaluate { project ->

         project.tasks.all({ task -> 
            if (task.name.contains("runAstParser"))
            {
                println " Scheduling  encryption to run after " + task.name;

                task.finalizedBy appProtectionInclude
                appProtectionInclude.mustRunAfter task
            } 
        });
    }
}