android {
    productFlavors {
        "protect" {
            dimension "protect"
        }
    }
}

def isWinOs = System.properties['os.name'].toLowerCase().contains('windows') ;  
def encryptionKey;

task appProtectionInclude (dependsOn: "collectAllJars")  << {

    println "App protection include started"  
       
    FileTree tree = fileTree(dir: "$rootDir/src/main/assets/app", include: ["**/*.js"], exclude:  ["**/app.js", "tns_modules/**"])
    tree.each { File file ->
        
        println "Encrypting file: " + file
        
        exec {
            commandLine "node", "../../node_modules/nativescript-app-protection/scripts/encrypt-file.js", encryptionKey , file.getAbsolutePath(),  file.getAbsolutePath()
        }
    } 
}

task generateEncryptionKey << {
    
    def stdout = new ByteArrayOutputStream()
    exec {
        commandLine "node", "../../node_modules/nativescript-app-protection/scripts/generate-aes256-key.js"
        standardOutput = stdout
    }
        
    println "Encryption key: " + stdout.toString();
    encryptionKey = stdout.toString();
}

task saveEncryptionKey << {
	
    String javaFileName = "$rootDir/src/main/java/com/tns/NativeScriptApplication.java";
    String contents = new File(javaFileName).getText("UTF-8");
    
    String protectionKeySetter = "com.tns.app_protection.AppProtection.setKey";
    String addThis = protectionKeySetter + "(\"" + encryptionKey + "\");";

    if (contents.contains(protectionKeySetter))
    {
       contents = contents.replaceFirst(protectionKeySetter + ".*", addThis)
    }
    else
    {
        contents = contents.replaceFirst(/public void onCreate\(\) \{/, "public void onCreate() {\n\t\t" + addThis);
    }
    
	new File(javaFileName).write(contents, "UTF-8");
}

// apply the plugin only for release builds
appProtectionInclude.onlyIf { project.hasProperty('release') }

saveEncryptionKey.dependsOn generateEncryptionKey
appProtectionInclude.dependsOn generateEncryptionKey

appProtectionInclude.mustRunAfter "collectAllJars"

appProtectionInclude.finalizedBy saveEncryptionKey

pluginExtend.finalizedBy appProtectionInclude 

tasks.whenTaskAdded { task ->
    if (task.getName() == "collectAllJars")
    {
        println "Patching collectAllJars task"
        task.finalizedBy appProtectionInclude 
    } 
}